#### 读写分离

##### 1、如何实现MySQL的读写分离？

- 考察点：高并发肯定需要做读写分离，而且大部分场景都是读多写少，即写一个主库，挂多个从库，从多个从库来读，那么如何实现MySQL的读写分离？MySQL主从复制的原理是什么？如何解决MySQL主从同步的延时问题？

######         如何实现MySQL的读写分离？

​		即基于主从复制架构，即一个主库，挂多个从库，主库用来写，然后主库会将数据同步到从库

###### 		MySQL主从复制原理是什么？

​		主库将变更写入binlog日志，然后从库连接到主库之后，从库有一个IO线程，将主库的binlog日志拷贝到自己本地，写入一个relay中继日志中，接着从库中有一个SQL线程会从中继日志中读取binlog，然后执行binlog日志中的内容，也就是在自己本地再次执行一遍SQL，这样即可以保证自己跟主库的数据是一样的

![mysql-master-slave](https://doocs.github.io/advanced-java/docs/high-concurrency/images/mysql-master-slave.png)

###### 		主从同步延时问题

​		主库上写入binlog日志是并行的，但从库上同步数据是串行化的，在高并发场景下，从库的数据一定会比主库慢一些，**有延时性**，可能经常刚写入主库的数据读不到，要等几十毫秒等才能读到

###### 		从库数据丢失问题

​		如果主库突然宕机，数据还没同步到从库，有些数据在从库上就丢失了

###### 		半同步复制

​		解决从库数据丢失问题。半同步复制也叫semi-sync复制，指的是主库写入binlog日志后，就会**强制**立即将数据同步到从库，从库将日志写入自己本地的relay log后，会返回一个ack给主库，主库接收到至少一个从库的ack之后才会确认写操作已完成

###### 		并行复制

​		解决主从同步延时问题。指的是从库开启多个线程，并行读取relay log中不同库的日志，然后并行重放不同库的日志，这是库级别的并行。

​		一般来说，如果主从延迟较为严重，有以下解决方案：

- 分库，将一个主库拆分为多个主库，每个主库的写并发就减少了几倍，此时主从延迟可以忽略不计。
- 打开 MySQL 支持的并行复制，多个库并行复制。如果说某个库的写入并发就是特别高，单库写并发达到了 2000/s，并行复制还是没意义。
- 重写代码，写代码的同学，要慎重，插入数据时立马查询可能查不到。
- 如果确实是存在必须先插入，立马要求就查询到，然后立马就要反过来执行一些操作，对这个查询**设置直连主库**。**不推荐**这种方法，你要是这么搞，读写分离的意义就丧失了。