# 消息队列

## 什么是消息队列

> 在[计算机科学](https://zh.wikipedia.org/wiki/计算机科学)中，**消息队列**（英语：Message queue）是一种[进程间通信](https://zh.wikipedia.org/wiki/进程间通信)或同一进程的不同[线程](https://zh.wikipedia.org/wiki/线程)间的通信方式，[软件](https://zh.wikipedia.org/wiki/軟體)的[贮列](https://zh.wikipedia.org/wiki/貯列)用来处理一系列的[输入](https://zh.wikipedia.org/wiki/输入)，通常是来自用户。------wikipedia

消息队列就是一个使用队列来通信的组件。但目前的消息队列往往指的是消息中间件，作用不仅仅局限于通信。

目前主流的消息队列有

各消息队列的对比，如何选型

## 为什么使用消息队列

### 异步处理

如秒杀

可以减少请求的等待，让服务异步并发处理，提升系统总体性能。

### 服务解耦

TODO

### 流量控制

TODO

日志处理、消息通讯....

**消息队列有什么优缺点**

- 引入消息队列带来的延迟问题
- 增加了系统的复杂度
- 可能产生数据不一致的情况

## 消息队列基本概念

消息队列有两种模型：**队列模型**和**发布/订阅模型**

### 队列模型

生产者往某个队列里面发送消息，一个队列可以存储多个生产者的消息，一个队列也可以有多个消费者，但是消费者之间是竞争关系，即**每条消息只能被一个消费者消费**。  

### 发布/订阅模型

**为了解决一条消息能被多个消费者消费的问题** ，出现了发布/订阅模型。该模型是将消息发往一个Topic 即主题中，所有订阅了这个 Topic 的订阅者都能消费 这条消息。

其实队列模型可以通过多队列全量存储相同的消息，即**数据的冗余**可以实现一条消息被多个消费者消费 。而RabbitMQ为了实现一条消息被多个消费者消费，采用队列模型，通过 Exchange 模块来将消息发送至多个队列，解决一条消息需要被多个消费者消费问题。

RabbitMQ 采用队列模型， RocketMQ 和 Kafka 采用发布/订阅模型。  

## 基本概念

### 队列/分区

TODO

### 消费者组

TODO

## 如何保证消息不丢失

- 消息发送阶段

TODO

- 消息存储阶段

TODO

- 消息消费阶段

TODO

## 如何处理消息重复

消息队列的消费语义

重复消息的发生情况：

1. Producer发送消息至Broker阶段
2. Consumer消费消息阶段

由此可知，重复消息无法避免，我们可以用幂等来处理重复消息。幂等实现的常见方式有**前置条件判断**、**数据库的约束如唯一键**，**关键的唯一key**等。

## 如何保证消息的有序性

### 全局有序

TODO

### 部分有序

TODO

## 如何处理消息堆积

TODO

## 如何设计一个消息队列

**BFS：先从大局上讲出需要设计的东西的重点，然后再等待面试官的继续提问，深挖**

TODO

## 消息队列设计成推模式还是拉模式

- 推模式
- 拉模式

## 消息队列之事务消息

- 2PC
- TCC

适用于异步更新，数据实时性不高的场景，为了解决生产者与消费者的数据一致性问题

列举消息中间件的案例....

# RocketMQ

## 架构设计

### Producer

### Consumer

### Broker

### NameServer

## RocketMQ为什么能这么快

## Features

# Kafka

## Kafka为什么弃用Zookeeper

